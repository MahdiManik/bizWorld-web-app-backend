name: BE Deployment

on:
  push:
    branches: [main]
    paths:
      - "strapi-be/**"
      - ".github/workflows/deploy-be.yml"

# Define environment variables at workflow level (non-sensitive)
env:
  HOST: 0.0.0.0
  PORT: 1337
  DATABASE_CLIENT: postgres
  DATABASE_HOST: 0.0.0.0
  DATABASE_NAME: biznest
  DATABASE_PORT: 5432
  DATABASE_SSL: false
  DATABASE_SSL_REJECT_UNAUTHORIZED: false
  CORS_ORIGIN: http://localhost:1337,http://localhost:3000
  MAILGUN_DOMAIN: nexstack.sg

  MINIO_ACCESS_KEY: wcuBv0PML3rB5lsu4hRm
  MINIO_SECRET_KEY: B1FjRTEzW3Bxzlw5nNbuRO8E7q40mwqooHilc8Qi
  MINIO_BUCKET: biz-world
  MINIO_ENDPOINT: minio-server.singaporetestlab.com
  MINIO_PORT: 443
  MINIO_USE_SSL: true
  MINIO_HOST: https://minio-server.singaporetestlab.com

jobs:
  deploy:
    runs-on: be
    environment: qat

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout 🛎
        uses: actions/checkout@v4

      - name: Setup Lock File Path
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
          cache-dependency-path: strapi-be/package-lock.json

      - name: Create environment file
        run: |
          cat > .env << EOL
          HOST=${HOST}
          PORT=${PORT}
          APP_KEYS=${{ secrets.APP_KEYS }}
          API_TOKEN_SALT=${{ secrets.API_TOKEN_SALT }}
          ADMIN_JWT_SECRET=${{ secrets.ADMIN_JWT_SECRET }}
          TRANSFER_TOKEN_SALT=${{ secrets.TRANSFER_TOKEN_SALT }}
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}

          DATABASE_CLIENT=${DATABASE_CLIENT}
          DATABASE_HOST=${DATABASE_HOST}
          DATABASE_NAME=${DATABASE_NAME}
          DATABASE_PORT=${DATABASE_PORT}
          DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}
          DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
          DATABASE_SSL=${DATABASE_SSL}
          DATABASE_SSL_REJECT_UNAUTHORIZED=${DATABASE_SSL_REJECT_UNAUTHORIZED}
          JWT_SECRET=${{ secrets.JWT_SECRET }}

          CORS_ORIGIN=${CORS_ORIGIN}

          MAIL_GUN_API_KEY=${{ secrets.MAIL_GUN_API_KEY }}
          MAILGUN_DOMAIN=${MAILGUN_DOMAIN}

          MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
          MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
          MINIO_BUCKET=${MINIO_BUCKET}
          MINIO_ENDPOINT=${MINIO_ENDPOINT}
          MINIO_PORT=${MINIO_PORT}
          MINIO_USE_SSL=${MINIO_USE_SSL}
          MINIO_HOST=${MINIO_HOST}

          EOL
        working-directory: strapi-be

      - name: Configure Git for GitHub packages
        run: |
          git config --global url."https://x-access-token:${{ github.token }}@github.com/".insteadOf "ssh://git@github.com/"
          git config --global url."https://x-access-token:${{ github.token }}@github.com/".insteadOf "git@github.com:"

      - name: Install dependencies 👨🏻‍💻
        run: |
          rm -rf node_modules package-lock.json
          npm cache clean --force
          npm install
        working-directory: strapi-be

      - name: Build Strapi app
        run: |
          npm run build
        working-directory: strapi-be

      - name: Check PM2 status before
        run: pm2 status

      - name: Restart Application with PM2
        run: |
          pm2 delete be || true  # Delete if exists, ignore error if not found
          pm2 start npm --name "be" -- start
        working-directory: strapi-be

      - name: Sync PM2
        run: pm2 save
